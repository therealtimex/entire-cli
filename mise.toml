[tools]
# Please also keep the version aligned in the go.mod file
go = { version = '1.25.5', postinstall = "go install github.com/golangci/golangci-lint/v2/cmd/golangci-lint@latest && go install github.com/go-delve/delve/cmd/dlv@latest" }
golangci-lint = 'latest'

[tasks.lint]
description = "Run linters"
run = "golangci-lint run ./..."

[tasks."lint:full"]
description = "Run linters on all code (not just new issues)"
run = "golangci-lint run --new=false --new-from-rev= --new-from-merge-base= ./..."

[tasks.fmt]
description = "Run linters"
run = "gofmt -w ."

[tasks.test]
description = "Run tests"
run = "go test ./..."

[tasks."test:integration"]
description = "Run integration tests"
run = "go test -tags=integration ./cmd/entire/cli/integration_test/..."

[tasks."test:ci"]
description = "Run all tests (unit + integration) with race detection"
run = "go test -tags=integration -race ./..."

[tasks.build]
description = "Build the CLI"
run = """
VERSION=$(git describe --tags --always --dirty 2>/dev/null || echo "dev")
COMMIT=$(git rev-parse --short HEAD 2>/dev/null || echo "unknown")
go build -ldflags "-X entire.io/cli/cmd/entire/cli.Version=${VERSION} -X entire.io/cli/cmd/entire/cli.Commit=${COMMIT}" -o entire ./cmd/entire
"""

[tasks."build:all"]
description = "Build for all platforms using goreleaser"
run = "goreleaser build --snapshot --clean"

[tasks."lint:gomod"]
description = "Check go.mod tidiness"
run = "go mod tidy && git diff --exit-code go.mod go.sum"
